input {
  # TCP 입력 - Spring Boot 애플리케이션에서 전송하는 JSON 로그
  tcp {
    port => 5044
    codec => json_lines
  }

  # 파일 입력 - elk-monitoring-system 로그
  file {
    path => "/logs/application.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    tags => ["elk-monitoring-system"]
  }

  # 파일 입력 - shoppingmall 로그
  file {
    path => "/logs/shoppingmall.log"
    start_position => "beginning"
    sincedb_path => "/logs/.sincedb_shoppingmall"
    codec => json
    tags => ["shoppingmall"]
  }
}

filter {
  # JSON 파싱
  if [message] {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
  }

  # 타임스탬프 파싱
  if [@timestamp] {
    date {
      match => ["@timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # 로그 레벨 추출
  if [level] {
    mutate {
      add_field => { "log_level" => "%{level}" }
    }
  }

  # 에러 레벨 태깅
  if [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
      add_field => { "alert_required" => "true" }
    }
  }

  # WARN 레벨 태깅
  if [level] == "WARN" {
    mutate {
      add_tag => ["warning"]
    }
  }

  # 애플리케이션 정보 추출
  if [logger_name] {
    grok {
      match => { "logger_name" => "com\.example\.elkmonitoring\.%{WORD:component}" }
    }
  }
}

output {
  # INFO 로그는 별도 인덱스에 저장
  if [level] == "INFO" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "application-logs-%{+YYYY.MM.dd}_info"
    }
  }
  # WARN, ERROR만 기본 인덱스에 저장
  else if [level] == "WARN" or [level] == "ERROR" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "application-logs-%{+YYYY.MM.dd}"
    }
  }
  # DEBUG는 아무 output도 없음 → 버려짐

  # 콘솔 출력 (디버깅용)
  stdout {
    codec => rubydebug
  }
}
